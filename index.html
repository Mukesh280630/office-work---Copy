<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Harvest Details Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore-compat.js"></script>

  <style>
    .hidden { display: none; }
    
    @media print {
      /* Defaults to portrait */
      
      body * {
        visibility: hidden;
      }
      .print-area, .print-area * {
        visibility: visible;
      }
      .print-area {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
      }
      
      /* Style the header specifically for printing */
      #mainHeader.print-area {
        position: absolute;
        top: 20px;
        left: 0;
        width: 100%;
        display: flex !important;
        justify-content: center !important;
        text-align: center;
        box-shadow: none !important;
        border: none !important;
        padding: 0 !important;
      }
      #mainHeader.print-area #loggedInUser {
        visibility: hidden;
      }
      #mainHeader.print-area #companyHeaderInfo {
        margin: 0 auto;
      }
      
      /* Adjust graph position to be below the header */
      #graph.print-area {
        top: 100px;
        border: 2px solid #000;
        padding: 20px;
      }
      
      /* Hide graph title and buttons when printing */
      #graph.print-area #graph-title-h2 {
        display: none;
      }
      #graph.print-area .button-container, #graph.print-area .filter-container {
         display: none;
      }
      
      /* Show the special print title */
      #graphPrintTitle {
        display: block !important;
        text-align: center;
        font-size: 1.5rem;
        font-weight: 600;
        color: #000;
        visibility: visible;
        margin-bottom: 20px;
      }

      body::after {
        content: "Verified by (Sign/Date)";
        position: fixed;
        bottom: 20px;
        right: 40px;
        visibility: visible;
        font-size: 12pt;
        color: #000;
      }
      
      body::before {
        content: "Prepared by (Sign/Date)";
        position: fixed;
        bottom: 20px;
        left: 40px;
        visibility: visible;
        font-size: 12pt;
        color: #000;
      }
    }
  </style>
</head>
<body class="bg-gray-100 font-sans">

  <div id="loginPage" class="min-h-screen" style="background-image: url('hero-slider01.jpg'); background-size: cover; background-position: center;">
    <div class="flex items-center justify-center min-h-screen w-full h-full bg-black bg-opacity-50">
      <div class="bg-white shadow-lg rounded-lg p-8 w-96 text-center border border-green-200">
        <img src="logo.png" alt="Logo" class="mx-auto mb-4 h-16">
        <h1 class="text-2xl font-bold text-green-700 mb-2">GreenSignal Bio Pharma Pvt. Ltd.</h1>
        <p class="text-sm text-gray-600 mb-6">No.49, Pappankuppam Village, Gummidipoondi, Chennai - 601201</p>
        <h2 class="text-xl font-semibold text-gray-700 mb-4">üîê Login</h2>
        <input id="username" type="text" placeholder="Username" class="border w-full mb-3 p-2 rounded focus:ring-2 focus:ring-green-500 outline-none">
        <input id="password" type="password" placeholder="Password" class="border w-full mb-4 p-2 rounded focus:ring-2 focus:ring-green-500 outline-none">
        <button onclick="login()" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-2 rounded transition">Login</button>
        <p id="error" class="text-red-500 mt-3 hidden">‚ùå Invalid username or password</p>
      </div>
    </div>
  </div>

  <div id="dashboardApp" class="hidden flex h-screen">
    <aside class="w-64 bg-green-700 text-white flex flex-col p-5 space-y-4 shadow-lg">
      <div class="flex flex-col items-center mb-4">
        <img src="logo.png" alt="Logo" class="h-16 mb-2 bg-white p-1 rounded">
        <h2 class="text-lg font-bold text-center leading-tight">GreenSignal<br>Bio Pharma Pvt. Ltd.</h2>
      </div>

      <nav class="space-y-4">
        <button id="dashboardBtn" onclick="showTab('dashboard')" class="w-full text-left px-3 py-2 rounded hover:bg-green-600">üìä Dashboard</button>
        <button id="activityBtn" onclick="showTab('activity')" class="w-full text-left px-3 py-2 rounded hover:bg-green-600">üß™ Culture Activity</button>
        <button id="cultureBtn" onclick="showTab('culture')" class="w-full text-left px-3 py-2 rounded hover:bg-green-600">üß´ Harvest Details</button>
        <button id="bioBtn" onclick="showTab('bio')" class="w-full text-left px-3 py-2 rounded hover:bg-green-600">üå± Bio Mass Trend</button>
        <button id="graphBtn" onclick="showTab('graph')" class="w-full text-left px-3 py-2 rounded hover:bg-green-600">üìà Graph</button>
        <button id="reportBtn" onclick="showTab('report')" class="w-full text-left px-3 py-2 rounded hover:bg-green-600">üìÑ Report Data</button>
        <button id="messageBtn" onclick="showTab('message')" class="w-full text-left px-3 py-2 rounded hover:bg-green-600 relative">
          ‚úâÔ∏è Message
          <span id="messageCountBadge" class="hidden absolute right-3 top-1/2 -translate-y-1/2 bg-red-500 text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center">0</span>
        </button>
        <button id="settingsBtn" onclick="showTab('settings')" class="w-full text-left px-3 py-2 rounded hover:bg-green-600">‚öôÔ∏è Settings</button>
        <button id="userPanelBtn" onclick="showTab('userPanel')" class="w-full text-left px-3 py-2 rounded hover:bg-green-600">üë§ User Panel</button>
      </nav>

      <div class="flex-grow"></div>
      <button onclick="logout()" class="bg-red-500 hover:bg-red-600 text-white px-3 py-2 rounded">üö™ Logout</button>
    </aside>

    <main class="flex-1 flex flex-col overflow-hidden">
      <header id="mainHeader" class="bg-white shadow px-8 py-4 flex justify-between items-center">
        <div id="companyHeaderInfo">
          <h1 class="text-2xl font-bold text-green-700">GreenSignal Bio Pharma Pvt. Ltd.</h1>
          <p class="text-gray-600 text-sm">No.49, Pappankuppam Village, Gummidipoondi, Chennai - 601201</p>
        </div>
        <div class="text-right">
          <span id="loggedInUser" class="font-semibold text-green-700"></span>
        </div>
      </header>

      <div class="flex-1 overflow-auto p-8">

        <section id="dashboard" class="tab">
          <h2 class="text-3xl font-bold text-green-700 mb-4">üìä Dashboard Overview</h2>
          
          <h3 class="text-xl font-semibold text-gray-800 mb-4 mt-6">üß™ Culture Activity Overview</h3>
          <div class="bg-white rounded-lg shadow p-6 border border-gray-300">
            <div class="overflow-x-auto">
              <table class="min-w-full border border-gray-300 bg-white rounded-lg">
                <thead class="bg-green-600 text-white">
                  <tr>
                    <th class="px-3 py-2">Date</th>
                    <th class="px-3 py-2">Revival</th>
                    <th class="px-3 py-2">P2/P3</th>
                    <th class="px-3 py-2">P2S1/P3S1</th>
                    <th class="px-3 py-2">P2S2/P3S2</th>
                    <th class="px-3 py-2">Harvest</th>
                  </tr>
                </thead>
                <tbody id="dashboardActivityTable" class="text-gray-800"></tbody>
              </table>
            </div>
          </div>
        </section>

        <section id="activity" class="tab hidden">
          <h2 class="text-3xl font-bold text-green-700 mb-4">üß™ Culture Activity Details</h2>

          <div class="bg-white rounded-lg shadow p-6 border border-gray-300 mb-6">
            <h3 class="text-xl font-semibold text-gray-800 mb-4">Batch ID Generator</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              
              <div>
                <label for="revivalDate" class="block text-sm font-medium text-gray-700">Revival Date</label>
                <input id="revivalDate" type="date" class="border p-2 w-full rounded focus:ring-2 focus:ring-green-500 outline-none mt-1">
              </div>
              <div>
                <label for="revivalId" class="block text-sm font-medium text-gray-700">Revival ID (e.g., MSP125R101)</label>
                <input id="revivalId" type="text" placeholder="MSP125R101" class="border p-2 w-full rounded focus:ring-2 focus:ring-green-500 outline-none mt-1 uppercase-input">
              </div>

              <div class="md:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-4 mt-4 border-t pt-4">
                <div>
                  <label for="p2p3" class="block text-sm font-medium text-gray-700">P2 / P3</label>
                  <input id="p2p3" type="text" class="border p-2 w-full rounded focus:ring-2 focus:ring-green-500 outline-none mt-1 bg-yellow-50 uppercase-input">
                </div>
                <div>
                  <label for="p2s1" class="block text-sm font-medium text-gray-700">P2S1 / P3S1</label>
                  <input id="p2s1" type="text" class="border p-2 w-full rounded bg-gray-100 mt-1 uppercase-input" readonly>
                </div>
                <div>
                  <label for="p2s2" class="block text-sm font-medium text-gray-700">P2S2 / P3S2</label>
                  <input id="p2s2" type="text" class="border p-2 w-full rounded bg-gray-100 mt-1 uppercase-input" readonly>
                </div>
                <div>
                  <label for="harvest" class="block text-sm font-medium text-gray-700">Harvest</label>
                  <input id="harvest" type="text" class="border p-2 w-full rounded bg-gray-100 mt-1 uppercase-input" readonly>
                </div>
              </div>
            </div>

            <div class="mt-6 text-right">
              <button onclick="saveBatch()" class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-2 px-6 rounded transition">üíæ Save Batch</button>
            </div>
            
          </div>
        </section>

        <section id="culture" class="tab hidden">
          <h2 class="text-3xl font-bold text-green-700 mb-4">üß´ Harvest Details</h2>
          <div class="overflow-x-auto">
            <table class="min-w-full border border-gray-300 bg-white rounded-lg shadow">
              <thead class="bg-green-600 text-white">
                <tr>
                  <th class="px-3 py-2">S.No</th>
                  <th class="px-3 py-2">Suspension No</th>
                  <th class="px-3 py-2">A</th>
                  <th class="px-3 py-2">B</th>
                  <th class="px-3 py-2">A - B (Cake Weight)</th>
                  <th class="px-3 py-2">NAg‚ÇÇ</th>
                  <th class="px-3 py-2">Sign & Date</th>
                  <th class="px-3 py-2">Start Time</th>
                  <th class="px-3 py-2">End Time</th>
                  <th class="px-3 py-2">Min</th>
                  <th class="px-3 py-2">Action</th>
                </tr>
              </thead>
              <tbody id="cultureTable" class="text-gray-800"></tbody>
            </table>
          </div>
          <div class="mt-4 flex justify-between">
            <button onclick="addRow()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">‚ûï Add Row</button>
            <button onclick="saveData()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">üíæ Save & Send to Bio Mass</button>
          </div>
        </section>

        <section id="bio" class="tab hidden">
          <h2 class="text-3xl font-bold text-green-700 mb-4">üå± Bio Mass Trend</h2>
          <table class="min-w-full border border-gray-300 bg-white rounded-lg shadow">
            <thead class="bg-green-600 text-white">
              <tr class="text-center">
                <th class="px-3 py-2">Suspension No</th>
                <th class="px-3 py-2">Cake Weight</th>
                <th class="px-3 py-2">Mean</th>
                <th class="px-3 py-2">Lower</th>
                <th class="px-3 py-2">Higher</th>
              </tr>
            </thead>
            <tbody id="bioTable" class="text-gray-800">
            </tbody>
          </table>
        </section>

        <section id="graph" class="tab hidden">
          <h2 id="graph-title-h2" class="text-3xl font-bold text-green-700 mb-4">üìà Graph</h2>
          
          <div class="filter-container bg-white p-4 rounded-lg shadow border border-gray-200 mb-6">
            <label for="graphMonth" class="font-semibold text-gray-700 mr-2">Filter by Month:</label>
            <select id="graphMonth" class="border rounded px-3 py-2">
              <option value="">-- Select Month --</option>
            </select>
            <button id="viewGraphBtn" onclick="drawGraph()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded ml-2">View Graph</button>
          </div>
          
          <div id="graphPrintWrapper">
            <h3 id="graphPrintTitle" class="hidden"></h3> <canvas id="bioChart" height="120"></canvas>
          </div>
          
          <div class="mt-4 space-x-2 button-container"> 
            <button onclick="printGraph()" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded">üñ®Ô∏è Print</button>
            <button onclick="exportGraphPDF()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">üìÑ Export PDF</button>
          </div>
        </section>

        <section id="report" class="tab hidden">
          <h2 class="text-3xl font-bold text-green-700 mb-4">üìÑ Report Data</h2>
          
          <div class="bg-white p-4 rounded-lg shadow border border-gray-200 mb-6">
            <label for="reportMonth" class="font-semibold text-gray-700 mr-2">Filter by Month:</label>
            <select id="reportMonth" class="border rounded px-3 py-2">
              <option value="">-- Select Month --</option>
            </select>
          </div>
          
          <div class="space-y-8">
            
            <div id="harvestReportContainer" class="bg-white rounded-lg shadow p-6 border border-gray-300">
              <h3 class="text-xl font-semibold text-gray-800 mb-4">Harvest Activity Report</h3>
              <div class="space-x-2 mb-4">
                <button id="viewHarvestReport" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">View</button>
                <button id="printHarvestReport" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded">üñ®Ô∏è Print</button>
              </div>
              <div class="overflow-x-auto">
                <table class="min-w-full border border-gray-300 bg-white rounded-lg">
                  <thead class="bg-green-600 text-white">
                    <tr>
                      <th class="px-3 py-2">Suspension No</th>
                      <th class="px-3 py-2">A</th>
                      <th class="px-3 py-2">B</th>
                      <th class="px-3 py-2">Cake Weight</th>
                      <th class="px-3 py-2">NAg‚ÇÇ</th>
                      <th class="px-3 py-2">Sign & Date</th>
                      <th class="px-3 py-2">Start Time</th>
                      <th class="px-3 py-2">End Time</th>
                      <th class="px-3 py-2">Min</th>
                    </tr>
                  </thead>
                  <tbody id="reportTableBody" class="text-gray-800">
                    <tr><td colspan="9" class="text-center p-4 text-gray-500">Select a month and click "View".</td></tr>
                  </tbody>
                </table>
              </div>
            </div>
            
            <div id="bioMassReportContainer" class="bg-white rounded-lg shadow p-6 border border-gray-300">
              <h3 class="text-xl font-semibold text-gray-800 mb-4">Bio Mass Data Report</h3>
              <div class="space-x-2 mb-4">
                <button id="viewBioMassReport" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">View</button>
                <button id="printBioMassReport" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded">üñ®Ô∏è Print</button>
              </div>
              <div class="overflow-x-auto">
                <table class="min-w-full border border-gray-300 bg-white rounded-lg">
                  <thead class="bg-green-600 text-white">
                    <tr class="text-center">
                      <th class="px-3 py-2">Suspension No</th>
                      <th class="px-3 py-2">Cake Weight</th>
                      <th class="px-3 py-2">Mean</th>
                      <th class="px-3 py-2">Lower</th>
                      <th class="px-3 py-2">Higher</th>
                    </tr>
                  </thead>
                  <tbody id="reportBioMassTableBody" class="text-gray-800">
                    <tr><td colspan="5" class="text-center p-4 text-gray-500">Select a month and click "View".</td></tr>
                  </tbody>
                </table>
              </div>
            </div>
            
            <div id="auditLogContainer" class="hidden bg-white rounded-lg shadow p-6 border border-gray-300">
              <h3 class="text-xl font-semibold text-gray-800 mb-4">Audit Log Report</h3>
              <div class="space-x-2 mb-4">
                <button id="viewAuditLog" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">View</button>
                <button id="printAuditLog" class="bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded">üñ®Ô∏è Print</button>
              </div>
              <div class="overflow-x-auto">
                <table class="min-w-full border border-gray-300 bg-white rounded-lg">
                  <thead class="bg-green-600 text-white">
                    <tr class="text-center">
                      <th class="px-3 py-2">Timestamp</th>
                      <th class="px-3 py-2">User</th>
                      <th class="px-3 py-2">Action</th>
                    </tr>
                  </thead>
                  <tbody id="auditLogTableBody" class="text-gray-800">
                    <tr><td colspan="3" class="text-center p-4 text-gray-500">Click "View" to load log.</td></tr>
                  </tbody>
                </table>
              </div>
            </div>

          </div>
        </section>
        
        <section id="message" class="tab hidden">
          <h2 class="text-3xl font-bold text-green-700 mb-4">‚úâÔ∏è Message Center</h2>
          
          <div id="sendMessageContainer" class="hidden bg-white p-6 rounded-lg shadow border border-gray-200 mb-6">
            <h3 class="text-xl font-semibold text-gray-800 mb-4">Send a New Message</h3>
            <textarea id="messageText" class="border p-2 w-full rounded focus:ring-2 focus:ring-green-500 outline-none" rows="3" placeholder="Type your message here..."></textarea>
            <button onclick="sendMessage()" class="mt-2 bg-green-600 hover:bg-green-700 text-white font-semibold py-2 px-6 rounded transition">Send Message</button>
          </div>
          
          <div class="bg-white p-6 rounded-lg shadow border border-gray-200">
             <h3 class="text-xl font-semibold text-gray-800 mb-4">Message Box</h3>
             <div id="messageBox" class="space-y-4 max-h-96 overflow-y-auto">
                </div>
          </div>
        </section>
        
        <section id="settings" class="tab hidden">
          <h2 class="text-3xl font-bold text-green-700 mb-4">‚öôÔ∏è Settings</h2>
          
          <div class="bg-white p-6 rounded-lg shadow border border-gray-200">
            <h3 class="text-xl font-semibold text-gray-800 mb-4">Change Password</h3>
            <div class="space-y-4 max-w-sm">
              <input id="oldPassword" type="password" placeholder="Old Password" class="border w-full p-2 rounded focus:ring-2 focus:ring-green-500 outline-none">
              <input id="newPassword" type="password" placeholder="New Password" class="border w-full p-2 rounded focus:ring-2 focus:ring-green-500 outline-none">
              <input id="confirmPassword" type="password" placeholder="Confirm New Password" class="border w-full p-2 rounded focus:ring-2 focus:ring-green-500 outline-none">
              <button onclick="changePassword()" class="w-full bg-green-600 hover:bg-green-700 text-white font-semibold py-2 rounded transition">Change Password</button>
            </div>
          </div>
        </section>

        <section id="userPanel" class="tab hidden">
          <h2 class="text-3xl font-bold text-green-700 mb-4">üë§ User Panel</h2>
          
          <div class="bg-white p-6 rounded-lg shadow border border-gray-200 mb-6">
            <h3 class="text-xl font-semibold text-gray-800 mb-4">Permission Management</h3>
            <table class="min-w-full">
              <thead class="bg-gray-100">
                <tr>
                  <th class="px-3 py-2 text-left">Role</th>
                  <th class="px-3 py-2 text-center">Culture Activity</th>
                  <th class="px-3 py-2 text-center">Harvest Details</th>
                  <th class="px-3 py-2 text-center">Bio Mass Trend</th>
                  <th class="px-3 py-2 text-center">Graph</th>
                  <th class="px-3 py-2 text-center">Report Data</th>
                  <th class="px-3 py-2 text-center">Message</th>
                  <th class="px-3 py-2 text-center">Settings</th>
                  <th class="px-3 py-2 text-center">User Panel</th>
                </tr>
              </thead>
              <tbody id="permissionsTableBody">
                </tbody>
            </table>
          </div>
          
          <div class="bg-white p-6 rounded-lg shadow border border-gray-200">
            <h3 class="text-xl font-semibold text-gray-800 mb-4">User Management</h3>
            <input id="newUsername" placeholder="Username" class="border rounded px-3 py-2 w-48">
            <input id="newPassword" placeholder="Password" type="password" class="border rounded px-3 py-2 w-48">
            <select id="newRole" class="border rounded px-3 py-2 w-48">
              <option>Operator</option>
              <option>Supervisor</option>
              <option>SME</option>
              <option>Manager</option>
              <option>Admin</option>
            </select>
            <button onclick="addUser()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded">‚ûï Add User</button>
            <table class="min-w-full border border-gray-300 bg-white rounded-lg mt-4">
              <thead class="bg-green-600 text-white">
                <tr class="text-center">
                  <th class="px-3 py-2">Username</th>
                  <th class="px-3 py-2">Password</th>
                  <th class="px-3 py-2">Role</th>
                  <th class="px-3 py-2">Action</th>
                </tr>
              </thead>
              <tbody id="userTable"></tbody>
            </table>
          </div>
          
          <div id="dangerZone" class="hidden mt-8 bg-red-50 p-6 rounded-lg shadow border border-red-300">
            <h3 class="text-xl font-semibold text-red-800 mb-4">Danger Zone - System Reset</h3>
            <p class="text-gray-700 mb-4">This action will permanently delete ALL **reports and messages**. User accounts and permissions will NOT be deleted.</p>
            <div class="flex items-center space-x-2">
              <input id="resetPasswordConfirm" type="password" placeholder="Confirm your password" class="border rounded px-3 py-2 w-64 focus:ring-2 focus:ring-red-500 outline-none">
              <button onclick="resetAllData()" class="bg-red-600 hover:bg-red-700 text-white font-semibold py-2 px-6 rounded transition">Reset Reports & Messages</button>
            </div>
          </div>
          
        </section>
      </div>
    </main>
  </div>

<script>
    lucide.createIcons();
    
    // --- [NEW] FIREBASE SETUP ---
    // 1. Paste your Firebase config object here
    const firebaseConfig = {
      apiKey: "AIzaSyCkI2phBxL6sQ6Fh7rHaGeWJmM_d6PtEl4",
      authDomain: "work-file-fae08.firebaseapp.com",
      projectId: "work-file-fae08",
      storageBucket: "work-file-fae08.firebasestorage.app",
      messagingSenderId: "148141344645",
      appId: "1:148141344645:web:66ba410c6499cc62f866ec"
    };

    // 2. Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore(); // This 'db' is your new database!
    // --- [END] FIREBASE SETUP ---
    
    
    let currentUser = null;
    let myChart = null; 

    document.addEventListener("keypress", e => {
      if (e.key === "Enter" && !document.getElementById("loginPage").classList.contains("hidden")) login();
    });

    // [MODIFIED] Using Firebase - WITH LOGIN FIX
    async function login() {
      const u=username.value.trim(),p=password.value.trim();
      let userObject = null;

      // First, check for the default admin
      if (u === "admin" && p === "12345") {
        userObject = { username: "admin", role: "Admin", id: "defaultAdmin", password: "12345" };
      } else {
        // Look in the database
        try {
          // [FIX] Query by username ONLY
          const snapshot = await db.collection("users")
            .where("username", "==", u) 
            .get();
            
          if (!snapshot.empty) {
            const userDoc = snapshot.docs[0];
            const userData = userDoc.data();
            
            // [FIX] Check password in JavaScript
            if (userData.password === p) {
              userObject = userData;
              userObject.id = userDoc.id;
            }
          }
        } catch (e) {
          console.error("Error logging in: ", e);
        }
      }

      if(userObject){
        loginPage.classList.add("hidden");
        dashboardApp.classList.remove("hidden");
        currentUser = userObject;
        document.getElementById("loggedInUser").textContent = `Welcome, ${currentUser.username}`;
        setupUIForRole(); 
        updateMessageCount(); 
        showTab('dashboard'); 
      } else {
        error.classList.remove("hidden");
      }
    }

    function logout(){
      showTab('dashboard'); 
      dashboardApp.classList.add("hidden");
      loginPage.classList.remove("hidden");
      username.value=password.value="";
      currentUser = null;
      document.getElementById("loggedInUser").textContent = "";
      
      document.getElementById('resetPasswordConfirm').value = "";
      
      document.getElementById('activityBtn').style.display = 'block';
      document.getElementById('cultureBtn').style.display = 'block';
      document.getElementById('bioBtn').style.display = 'block';
      document.getElementById('graphBtn').style.display = 'block';
      document.getElementById('reportBtn').style.display = 'block';
      document.getElementById('messageBtn').style.display = 'block';
      document.getElementById('settingsBtn').style.display = 'block';
      document.getElementById('userPanelBtn').style.display = 'block';
      
      document.getElementById('messageCountBadge').classList.add('hidden');
    }

    // [MODIFIED] Using Firebase for permissions
    async function getPermissions() {
      const defaultPerms = {
        "Operator": { "culture": true, "harvest": true, "bio": true, "graph": true, "report": false, "message": true, "settings": true, "userPanel": false },
        "Supervisor": { "culture": true, "harvest": true, "bio": true, "graph": true, "report": true, "message": true, "settings": true, "userPanel": false },
        "SME": { "culture": true, "harvest": true, "bio": true, "graph": true, "report": true, "message": true, "settings": true, "userPanel": false },
        "Manager": { "culture": true, "harvest": true, "bio": true, "graph": true, "report": true, "message": true, "settings": true, "userPanel": true },
        "Admin": { "culture": true, "harvest": true, "bio": true, "graph": true, "report": true, "message": true, "settings": true, "userPanel": true }
      };
      
      try {
        const doc = await db.collection("settings").doc("appPermissions").get();
        if (doc.exists) {
          const perms = doc.data();
          // Ensure new roles/perms are added if missing from storage
          return { 
            ...defaultPerms, 
            "Operator": { ...defaultPerms.Operator, ...perms.Operator },
            "Supervisor": { ...defaultPerms.Supervisor, ...perms.Supervisor },
            "SME": { ...defaultPerms.SME, ...perms.SME },
            "Manager": { ...defaultPerms.Manager, ...perms.Manager },
            "Admin": { ...defaultPerms.Admin, ...perms.Admin }
          };
        } else {
          // No permissions saved yet, save the defaults
          await db.collection("settings").doc("appPermissions").set(defaultPerms);
          return defaultPerms;
        }
      } catch (e) {
        console.error("Error getting permissions:", e);
        return defaultPerms;
      }
    }

    // [MODIFIED] Using Firebase
    async function savePermission(role, page, isAllowed) {
      const perms = await getPermissions();
      if (perms[role]) {
        perms[role][page] = isAllowed;
      }
      // Save all permissions back to the single document
      try {
        await db.collection("settings").doc("appPermissions").set(perms);
      } catch (e) {
        console.error("Error saving permission:", e);
      }
    }

    // [MODIFIED] Using Firebase
    async function loadPermissions() {
      const perms = await getPermissions();
      const tableBody = document.getElementById('permissionsTableBody');
      tableBody.innerHTML = "";
      
      const rolesToDisplay = ['Operator', 'Supervisor', 'SME', 'Manager'];
      
      rolesToDisplay.forEach(role => {
        const p = perms[role];
        const tr = document.createElement('tr');
        tr.className = "border-t";
        tr.innerHTML = `
          <td class="px-3 py-2 font-semibold">${role}</td>
          <td class="px-3 py-2 text-center"><input type="checkbox" onchange="savePermission('${role}', 'culture', this.checked)" ${p.culture ? 'checked' : ''}></td>
          <td class="px-3 py-2 text-center"><input type="checkbox" onchange="savePermission('${role}', 'harvest', this.checked)" ${p.harvest ? 'checked' : ''}></td>
          <td class="px-3 py-2 text-center"><input type="checkbox" onchange="savePermission('${role}', 'bio', this.checked)" ${p.bio ? 'checked' : ''}></td>
          <td class="px-3 py-2 text-center"><input type="checkbox" onchange="savePermission('${role}', 'graph', this.checked)" ${p.graph ? 'checked' : ''}></td>
          <td class="px-3 py-2 text-center"><input type="checkbox" onchange="savePermission('${role}', 'report', this.checked)" ${p.report ? 'checked' : ''}></td>
          <td class="px-3 py-2 text-center"><input type="checkbox" onchange="savePermission('${role}', 'message', this.checked)" ${p.message ? 'checked' : ''}></td>
          <td class="px-3 py-2 text-center"><input type="checkbox" onchange="savePermission('${role}', 'settings', this.checked)" ${p.settings ? 'checked' : ''}></td>
          <td class="px-3 py-2 text-center"><input type="checkbox" onchange="savePermission('${role}', 'userPanel', this.checked)" ${p.userPanel ? 'checked' : ''}></td>
        `;
        tableBody.appendChild(tr);
      });
    }
    
    // [MODIFIED] Using Firebase
    async function setupUIForRole() {
      if (!currentUser) return;
      
      const sendMessageContainer = document.getElementById('sendMessageContainer');
      if (['Admin', 'Manager', 'SME'].includes(currentUser.role)) {
        sendMessageContainer.classList.remove('hidden');
      } else {
        sendMessageContainer.classList.add('hidden');
      }
      
      const dangerZone = document.getElementById('dangerZone');
      if (currentUser.role === 'Admin') {
        dangerZone.classList.remove('hidden');
      } else {
        dangerZone.classList.add('hidden');
      }
      
      // [NEW] Show/Hide Audit Log
      const auditLogContainer = document.getElementById('auditLogContainer');
      if (currentUser.role === 'Admin') {
        auditLogContainer.classList.remove('hidden');
      } else {
        auditLogContainer.classList.add('hidden');
      }

      const perms = (await getPermissions())[currentUser.role];
      if (!perms) {
        logout();
        return;
      }

      if (currentUser.role === 'Admin') {
        document.getElementById('activityBtn').style.display = 'block';
        document.getElementById('cultureBtn').style.display = 'block';
        document.getElementById('bioBtn').style.display = 'block';
        document.getElementById('graphBtn').style.display = 'block';
        document.getElementById('reportBtn').style.display = 'block';
        document.getElementById('messageBtn').style.display = 'block';
        document.getElementById('settingsBtn').style.display = 'block';
        document.getElementById('userPanelBtn').style.display = 'block';
        return;
      }
      
      document.getElementById('activityBtn').style.display = perms.culture ? 'block' : 'none';
      document.getElementById('cultureBtn').style.display = perms.harvest ? 'block' : 'none';
      document.getElementById('bioBtn').style.display = perms.bio ? 'block' : 'none';
      document.getElementById('graphBtn').style.display = perms.graph ? 'block' : 'none';
      document.getElementById('reportBtn').style.display = perms.report ? 'block' : 'none';
      document.getElementById('messageBtn').style.display = perms.message ? 'block' : 'none';
      document.getElementById('settingsBtn').style.display = perms.settings ? 'block' : 'none';
      document.getElementById('userPanelBtn').style.display = perms.userPanel ? 'block' : 'none';
    }

    // [MODIFIED] Using Firebase
    async function showTab(id){
      if (currentUser && currentUser.role !== 'Admin') {
        const perms = (await getPermissions())[currentUser.role];
        if (id === 'activity' && !perms.culture) return;
        if (id === 'culture' && !perms.harvest) return;
        if (id === 'bio' && !perms.bio) return;
        if (id === 'graph' && !perms.graph) return;
        if (id === 'report' && !perms.report) return;
        if (id === 'message' && !perms.message) return;
        if (id === 'settings' && !perms.settings) return;
        if (id === 'userPanel' && !perms.userPanel) return;
      }
      
      document.querySelectorAll(".tab").forEach(t=>t.classList.add("hidden"));
      document.getElementById(id).classList.remove("hidden");
      
      if(id==="bio")loadBioData();
      if(id==="userPanel") {
        loadUsers();
        loadPermissions(); 
      }
      if(id==="dashboard")loadDashboardActivity();
      if(id==="graph") populateGraphFilter();
      if(id==="report") {
        populateReportFilter();
        if (currentUser && currentUser.role === 'Admin') {
          loadAuditLog(); // Load audit log for admin
        }
      }
      if(id==="message") {
        loadMessages();
        markMessagesAsRead(); 
      }
    }

    // --- HARVEST DETAILS ---
    function addRow(){
      const t=cultureTable;
      const tr=document.createElement("tr");
      tr.innerHTML=`<td class="text-center"></td> <td><input class='border p-1 w-full uppercase-input'></td> <td><input type='number' class='border p-1 w-full' oninput='calcDiff(this)'></td> <td><input type='number' class='border p-1 w-full' oninput='calcDiff(this)'></td> <td><input class='border p-1 w-full bg-gray-100' readonly></td> <td><input class='border p-1 w-full bg-gray-100' readonly></td> <td><input class='border p-1 w-full bg-gray-100' readonly></td> <td><input type='time' class='border p-1 w-full'></td> <td><input class='border p-1 w-full bg-gray-100' readonly></td> <td><input type='number' class='border p-1 w-full' oninput='calcEndTime(this)'></td> <td class="text-center"><button onclick='deleteRow(this)' class='bg-red-500 text-white px-2 py-1 rounded'>üóëÔ∏è</button></td> `;
      t.appendChild(tr);
      enableUppercase();
      renumberHarvestRows();
    }
    
    function deleteRow(btn) {
      const tr = btn.closest("tr");
      tr.remove();
      renumberHarvestRows();
    }
    
    function renumberHarvestRows() {
      document.querySelectorAll("#cultureTable tr").forEach((row, index) => {
        const rowNum = index + 1;
        row.querySelector("td:first-child").textContent = rowNum;
        const inputs = row.querySelectorAll("input");
        inputs[1].id = `A${rowNum}`;
        inputs[2].id = `B${rowNum}`;
        inputs[3].id = `Diff${rowNum}`;
        inputs[4].id = `NAg2${rowNum}`;
        inputs[5].id = `SignDate${rowNum}`;
        
        const startTimeInput = inputs[6];
        startTimeInput.id = `Start${rowNum}`;
        
        inputs[7].id = `End${rowNum}`;
        inputs[8].id = `Min${rowNum}`;
        
        if (rowNum === 1) {
          startTimeInput.readOnly = false;
          startTimeInput.classList.remove("bg-gray-100");
        } else {
          startTimeInput.readOnly = true;
          startTimeInput.classList.add("bg-gray-100");
        }
        
        inputs[1].setAttribute('oninput', 'calcDiff(this)');
        inputs[2].setAttribute('oninput', 'calcDiff(this)');
        inputs[8].setAttribute('oninput', 'calcEndTime(this)');
      });
    }

    function calcDiff(inputElement){
      const row = inputElement.closest('tr');
      const rowNum = row.querySelector("td:first-child").textContent;
      const inputs = row.querySelectorAll("input");
      const A = parseFloat(inputs[1].value) || 0;
      const B = parseFloat(inputs[2].value) || 0;
      const diffInput = inputs[3];
      const nag2Input = inputs[4];
      const signDateInput = inputs[5];
      const startTimeInput = inputs[6]; 

      const d = A - B;
      diffInput.value = d.toFixed(2);
      nag2Input.value = ((d * 1000) / 80).toFixed(2);
      
      const n = new Date();
      
      if (!signDateInput.value) {
          signDateInput.value = `${currentUser.username} & ${n.toLocaleDateString("en-GB")}`;
      }
      
      if (rowNum === '1' && !startTimeInput.value) { 
          const hours = n.getHours().toString().padStart(2, '0');
          const minutes = n.getMinutes().toString().padStart(2, '0');
          startTimeInput.value = `${hours}:${minutes}`;
      }
    }
    
    function calcEndTime(inputElement) {
      const row = inputElement.closest('tr');
      const inputs = row.querySelectorAll("input");
      const signDateInput = inputs[5];
      const startTimeInput = inputs[6];
      const endTimeInput = inputs[7];
      const minVal = parseFloat(inputElement.value) || 0;
      
      const datePartStr = signDateInput.value.split('&')[1]?.trim();
      const timePartStr = startTimeInput.value;
      
      if (!datePartStr || !timePartStr) { 
        return; 
      }
      
      try {
        const [day, month, year] = datePartStr.split('/');
        const [hours, minutes] = timePartStr.split(':');
        
        const startTime = new Date(`${year}-${month}-${day}T${hours}:${minutes}:00`);
        if (isNaN(startTime.getTime())) return; 
        
        const endTime = new Date(startTime.getTime() + minVal * 60000); 
        
        const endHours = endTime.getHours().toString().padStart(2, '0');
        const endMinutes = endTime.getMinutes().toString().padStart(2, '0');
        endTimeInput.value = `${endHours}:${endMinutes}`;
        
        const nextRow = row.nextElementSibling;
        if (nextRow) {
          const nextRowInputs = nextRow.querySelectorAll("input");
          const nextStartTimeInput = nextRowInputs[6];
          const nextSignDateInput = nextRowInputs[5];

          const nextStartTime = new Date(endTime.getTime() + 2 * 60000);

          const nextHours = nextStartTime.getHours().toString().padStart(2, '0');
          const nextMinutes = nextStartTime.getMinutes().toString().padStart(2, '0');
          nextStartTimeInput.value = `${nextHours}:${nextMinutes}`;
          
          nextSignDateInput.value = `${currentUser.username} & ${nextStartTime.toLocaleDateString("en-GB")}`;
        }

      } catch (e) {
        console.error("Error parsing date/time:", e);
      }
    }

    // --- Uppercase Helper ---
    function uppercaseHandler(e) {
      e.target.value = e.target.value.toUpperCase();
    }

    function enableUppercase(){
      document.querySelectorAll(".uppercase-input").forEach(i=>{
        i.removeEventListener("input", uppercaseHandler);
        i.addEventListener("input", uppercaseHandler);
      });
    }
    
    enableUppercase();

    // [MODIFIED] Using Firebase
    async function saveData(){
      const rows=[...document.querySelectorAll("#cultureTable tr")];
      let bioMassPayload = [];
      let batch = db.batch(); // Create a batch write
      
      let dataToSave = false;
      
      rows.forEach(r => {
        const x = r.querySelectorAll("input");
        const suspension = x[0]?.value.toUpperCase();
        if (!suspension) return; 

        dataToSave = true;
        const cakeWeight = parseFloat(x[3].value) || 0;
        
        // 1. Data for Bio Mass (will be saved at the end)
        bioMassPayload.push({ 
          suspension: suspension, 
          cakeWeight: cakeWeight
        });
        
        // 2. Data for Report
        const reportData = {
          suspension: suspension,
          A: x[1]?.value,
          B: x[2]?.value,
          cakeWeight: cakeWeight.toFixed(2),
          nag2: x[4]?.value,
          signDate: x[5]?.value,
          startTime: x[6]?.value,
          endTime: x[7]?.value,
          min: x[8]?.value,
          timestamp: firebase.firestore.FieldValue.serverTimestamp() // For sorting
        };
        // Add a new document to the "harvestReport" collection
        const docRef = db.collection("harvestReport").doc();
        batch.set(docRef, reportData);
      });
      
      if (!dataToSave) {
        return alert("No data to save.");
      }

      try {
        // 3. Save Bio Mass data to a single document
        // This overwrites the old bio mass data, which is correct
        await db.collection("settings").doc("bioMassData").set({ data: bioMassPayload });
        
        // 4. Save the batch of harvest reports
        await batch.commit();
        
        alert("‚úÖ Data saved and sent to Bio Mass & Report.");
        loadBioData(); 
        
        cultureTable.innerHTML = "";
        addRow(); 
      } catch (e) {
        console.error("Error saving data: ", e);
        alert("Error saving data. See console for details.");
      }
    }

    // --- BIO MASS FUNCTIONS ---
    // [MODIFIED] Using Firebase
    async function loadBioData(){
      const t=bioTable; t.innerHTML="";
      let d = [];
      
      try {
        const doc = await db.collection("settings").doc("bioMassData").get();
        if (doc.exists) {
          d = doc.data().data; // Get the array from the 'data' field
        }
      } catch(e) { console.error("Error loading bio mass: ", e); }

      // Get mean from a separate doc
      let savedMean = "16.06";
      try {
        const meanDoc = await db.collection("settings").doc("bioMassMean").get();
        if (meanDoc.exists) {
          savedMean = meanDoc.data().value;
        }
      } catch(e) { console.error("Error loading mean: ", e); }


      if (d.length === 0) {
        t.innerHTML = `<tr><td colspan="5" class="text-center p-4 text-gray-500">No data. Add data from Harvest Details.</td></tr>`;
        return;
      }

      d.forEach((x,i)=>{
        const tr=document.createElement("tr");
        tr.className = "text-center"; 

        let meanCellHtml;
        if (i === 0) {
          meanCellHtml = `<td class="p-2 border-t">
            <input 
              type="number" 
              step="0.01"
              id="mainMeanInput" 
              value="${savedMean}" 
              oninput="updateMirroredMeans(this.value)" 
              class="border p-1 w-24 text-center mx-auto"
            >
          </td>`;
        } else {
          meanCellHtml = `<td class="p-2 border-t">
            <span class="mirrored-mean">${savedMean}</span>
          </td>`;
        }

        tr.innerHTML=`
          <td class="p-2 border-t">${x.suspension}</td>
          <td class="p-2 border-t">${(x.cakeWeight || 0).toFixed(2)}</td>
          ${meanCellHtml}
          <td class="p-2 border-t">12</td>
          <td class="p-2 border-t">18</td>
        `;
        t.appendChild(tr);
      });
    }

    // [MODIFIED] Using Firebase
    async function updateMirroredMeans(value) {
      // 1. Save the value to Firestore
      try {
        await db.collection("settings").doc("bioMassMean").set({ value: value });
      } catch(e) {
        console.error("Error saving mean: ", e);
      }
      
      // 2. Update all mirrored-mean spans
      document.querySelectorAll(".mirrored-mean").forEach(span => {
        span.textContent = value;
      });
    }
    
    // --- REPORT TAB FUNCTIONS ---
    
    // [MODIFIED] Using Firebase
    async function populateReportFilter() {
      const selectEl = document.getElementById('reportMonth');
      selectEl.innerHTML = '<option value="">-- Select Month --</option>'; // Clear
      const monthSet = new Set();

      try {
        const snapshot = await db.collection("harvestReport").get();
        snapshot.forEach(doc => {
          const b = doc.data();
          if (!b.signDate) return;
          try {
            const datePartStr = b.signDate.split('&')[1]?.trim();
            const [day, month, year] = datePartStr.split('/');
            const recordMonth = `${year}-${month.padStart(2, '0')}`;
            monthSet.add(recordMonth);
          } catch (e) { /* ignore */ }
        });
        
        Array.from(monthSet).sort().reverse().forEach(monthYear => {
          const [year, month] = monthYear.split('-');
          const dateObj = new Date(year, month - 1);
          const monthName = dateObj.toLocaleString('default', { month: 'long' });
          const label = `${monthName} ${year}`;
          const option = new Option(label, monthYear);
          selectEl.add(option);
        });
      } catch(e) {
        console.error("Error populating report filter: ", e);
      }
    }

    // [MODIFIED] Using Firebase
    async function getFilteredReportData() {
      const selectedMonth = document.getElementById('reportMonth').value;
      if (!selectedMonth) {
        alert("Please select a month to filter.");
        return null;
      }
      
      const allData = [];
      try {
        const snapshot = await db.collection("harvestReport").get();
        snapshot.forEach(doc => {
          allData.push(doc.data());
        });
      } catch(e) {
        console.error("Error getting report data: ", e);
        return null;
      }
      
      const filteredData = allData.filter(b => {
        if (!b.signDate) return false;
        try {
          const datePartStr = b.signDate.split('&')[1]?.trim();
          const [day, month, year] = datePartStr.split('/');
          const recordMonth = `${year}-${month.padStart(2, '0')}`;
          return recordMonth === selectedMonth;
        } catch (e) {
          return false;
        }
      });
      
      return filteredData;
    }
    
    // [MODIFIED] Using Firebase
    async function loadReportData() {
      const t = document.getElementById('reportTableBody');
      const data = await getFilteredReportData();
      
      if (data === null) return;
      t.innerHTML = ""; 

      if (data.length === 0) {
        t.innerHTML = `<tr><td colspan="9" class="text-center p-4 text-gray-500">No harvest data found for this month.</td></tr>`;
        return;
      }

      data.forEach(b => {
        const tr = document.createElement("tr");
        tr.className = "hover:bg-gray-50 text-center";
        tr.innerHTML = `
          <td class="border-t px-3 py-2">${b.suspension}</td>
          <td class="border-t px-3 py-2">${b.A}</td>
          <td class="border-t px-3 py-2">${b.B}</td>
          <td class="border-t px-3 py-2">${b.cakeWeight}</td>
          <td class="border-t px-3 py-2">${b.nag2}</td>
          <td class="border-t px-3 py-2">${b.signDate}</td>
          <td class="border-t px-3 py-2">${b.startTime}</td>
          <td class="border-t px-3 py-2">${b.endTime}</td>
          <td class="border-t px-3 py-2">${b.min}</td>
        `;
        t.appendChild(tr);
      });
    }
    
    // [MODIFIED] Using Firebase
    async function loadBioMassReportData() {
      const t = document.getElementById('reportBioMassTableBody');
      const data = await getFilteredReportData();
      
      if (data === null) return;
      t.innerHTML = "";
      
      let savedMean = "16.06";
      try {
        const meanDoc = await db.collection("settings").doc("bioMassMean").get();
        if (meanDoc.exists) {
          savedMean = meanDoc.data().value;
        }
      } catch(e) { console.error("Error loading mean: ", e); }

      if (data.length === 0) {
        t.innerHTML = `<tr><td colspan="5" class="text-center p-4 text-gray-500">No bio mass data found for this month.</td></tr>`;
        return;
      }

      data.forEach((x,i)=>{
        const tr=document.createElement("tr");
        tr.className = "text-center"; 

        let meanCellHtml;
        if (i === 0) {
          meanCellHtml = `<td class="p-2 border-t">
            <input 
              type="number" 
              step="0.01"
              value="${savedMean}" 
              oninput="updateMirroredMeans(this.value)" 
              class="border p-1 w-24 text-center mx-auto main-mean-report"
            >
          </td>`;
        } else {
          meanCellHtml = `<td class="p-2 border-t">
            <span class="mirrored-mean-report">${savedMean}</span>
          </td>`;
        }

        tr.innerHTML=`
          <td class="p-2 border-t">${x.suspension}</td>
          <td class="p-2 border-t">${x.cakeWeight}</td>
          ${meanCellHtml}
          <td class="p-2 border-t">12</td>
          <td class="p-2 border-t">18</td>
        `;
        t.appendChild(tr);
      });
      
      document.querySelector('.main-mean-report')?.addEventListener('input', (e) => {
        document.querySelectorAll(".mirrored-mean-report").forEach(span => {
          span.textContent = e.target.value;
        });
      });
    }
    
    // [NEW] Load Audit Log Data
    async function loadAuditLog() {
      const t = document.getElementById('auditLogTableBody');
      if (!t) return; 
      t.innerHTML = "";
      
      let data = [];
      try {
        const snapshot = await db.collection("auditLog").orderBy("timestamp", "desc").get();
        snapshot.forEach(doc => {
          data.push(doc.data());
        });
      } catch(e) { console.error("Error loading audit log: ", e); }

      if (data.length === 0) {
        t.innerHTML = `<tr><td colspan="3" class="text-center p-4 text-gray-500">No audit activity found.</td></tr>`;
        return;
      }

      data.forEach(b => {
        const tr = document.createElement("tr");
        tr.className = "hover:bg-gray-50 text-center";
        tr.innerHTML = `
          <td class="border-t px-3 py-2">${b.timestamp.toDate().toLocaleString('en-GB')}</td>
          <td class="border-t px-3 py-2">${b.username}</td>
          <td class="border-t px-3 py-2">${b.action}</td>
        `;
        t.appendChild(tr);
      });
    }
    
    function printSection(containerId) {
      document.querySelectorAll('.print-area').forEach(el => el.classList.remove('print-area'));
      document.getElementById(containerId).classList.add('print-area');
      window.print();
    }
    
    document.getElementById('viewHarvestReport').onclick = loadReportData;
    document.getElementById('viewBioMassReport').onclick = loadBioMassReportData;
    document.getElementById('printHarvestReport').onclick = () => printSection('harvestReportContainer');
    document.getElementById('printBioMassReport').onclick = () => printSection('bioMassReportContainer');
    // [NEW] Buttons for audit log
    document.getElementById('viewAuditLog').onclick = loadAuditLog;
    document.getElementById('printAuditLog').onclick = () => printSection('auditLogContainer');


    // --- DASHBOARD OVERVIEW FUNCTIONS ---
    // [MODIFIED] Using Firebase
    async function saveBatch() {
      const batchData = {
        date: document.getElementById('revivalDate').value,
        revival: document.getElementById('revivalId').value.toUpperCase(),
        p2p3: document.getElementById('p2p3').value.toUpperCase(),
        p2s1: document.getElementById('p2s1').value.toUpperCase(),
        p2s2: document.getElementById('p2s2').value.toUpperCase(),
        harvest: document.getElementById('harvest').value.toUpperCase(),
        timestamp: firebase.firestore.FieldValue.serverTimestamp() // For sorting
      };

      if (!batchData.date || !batchData.revival) {
        return alert("‚ùå Please enter at least a Revival Date and Revival ID.");
      }
      
      try {
        await db.collection("batchActivity").add(batchData);
        alert("‚úÖ Batch saved successfully!");
        document.getElementById('revivalDate').value = '';
        document.getElementById('revivalId').value = '';
        handleRevivalIdChange({ target: { value: '' } }); 
        loadDashboardActivity();
      } catch (e) {
        console.error("Error saving batch: ", e);
      }
    }

    // [MODIFIED] Using Firebase
    async function loadDashboardActivity() {
      const t = document.getElementById('dashboardActivityTable');
      if (!t) return; 
      t.innerHTML = "";
      
      let data = [];
      try {
        const snapshot = await db.collection("batchActivity").orderBy("timestamp", "desc").get();
        snapshot.forEach(doc => {
          data.push(doc.data());
        });
      } catch(e) { console.error("Error loading dashboard data: ", e); }

      if (data.length === 0) {
        t.innerHTML = `<tr><td colspan="6" class="text-center p-4 text-gray-500">No batch activity saved yet.</td></tr>`;
        return;
      }

      data.forEach(b => {
        let displayDate = b.date;
        if (b.date) {
          try {
            const parts = b.date.split('-');
            displayDate = `${parts[2]}/${parts[1]}/${parts[0]}`;
          } catch (e) {
             displayDate = b.date;
          }
        }
      
        const tr = document.createElement("tr");
        tr.className = "hover:bg-gray-50";
        tr.innerHTML = `
          <td class="border-t px-3 py-2">${displayDate}</td>
          <td class="border-t px-3 py-2">${b.revival}</td>
          <td class="border-t px-3 py-2">${b.p2p3}</td>
          <td class="border-t px-3 py-2">${b.p2s1}</td>
          <td class="border-t px-3 py-2">${b.p2s2}</td>
          <td class="border-t px-3 py-2">${b.harvest}</td>
        `;
        t.appendChild(tr);
      });
    }

    // --- BATCH ID GENERATOR FUNCTIONS ---
    function handleRevivalIdChange(e) {
        const revivalId = e.target.value.toUpperCase();
        const p2p3El = document.getElementById('p2p3');

        if (revivalId.length < 4) { 
            clearGeneratedFields();
            return;
        }
        const prefix = revivalId.substring(0, 3);
        const suffix = revivalId.substring(3);
        const p2p3Val = prefix + suffix.replace('1', '2'); 
        p2p3El.value = p2p3Val;
        handleP2P3Change({ target: { value: p2p3Val } });
    }

    function handleP2P3Change(e) {
        const p2p3Val = e.target.value.toUpperCase();
        const revivalIdVal = document.getElementById('revivalId').value.toUpperCase(); 

        const p2s1El = document.getElementById('p2s1');
        const p2s2El = document.getElementById('p2s2');
        const harvestEl = document.getElementById('harvest');

        if (p2p3Val.length < 4 || revivalIdVal.length < 4) {
            p2s1El.value = ''; p2s2El.value = ''; harvestEl.value = '';
            return;
        }

        const pNum = p2p3Val.charAt(3); 
        const revivalSuffix = revivalIdVal.substring(3); 
        const p2p3Suffix = p2p3Val.substring(3); 
        const p2p3SuffixNoFirst = p2p3Val.substring(4);

        p2s1El.value = 'P' + pNum + 'S' + revivalSuffix;
        p2s2El.value = 'P' + pNum + 'S2' + p2p3SuffixNoFirst;
        harvestEl.value = 'HTP' + p2p3Suffix;
    }

    // [REMOVED] handleDateChange function

    function clearGeneratedFields() {
        document.getElementById('p2p3').value = '';
        handleP2P3Change({ target: { value: '' } });
    }
    
    document.getElementById('revivalId').addEventListener('input', handleRevivalIdChange);
    document.getElementById('p2p3').addEventListener('input', handleP2P3Change);
    // [REMOVED] revivalDate event listener
    

    // --- [MODIFIED] GRAPH ---
    
    // [MODIFIED] Using Firebase
    async function populateGraphFilter() {
      const selectEl = document.getElementById('graphMonth');
      selectEl.innerHTML = '<option value="">-- Select Month --</option>'; // Clear
      const monthSet = new Set();
      
      try {
        const snapshot = await db.collection("harvestReport").get();
        snapshot.forEach(doc => {
          const b = doc.data();
          if (!b.signDate) return;
          try {
            const datePartStr = b.signDate.split('&')[1]?.trim();
            const [day, month, year] = datePartStr.split('/');
            const recordMonth = `${year}-${month.padStart(2, '0')}`;
            monthSet.add(recordMonth);
          } catch (e) { /* ignore */ }
        });
        
        Array.from(monthSet).sort().reverse().forEach(monthYear => {
          const [year, month] = monthYear.split('-');
          const dateObj = new Date(year, month - 1);
          const monthName = dateObj.toLocaleString('default', { month: 'long' });
          const label = `${monthName} ${year}`;
          const option = new Option(label, monthYear);
          selectEl.add(option);
        });
      } catch(e) {
        console.error("Error populating graph filter: ", e);
      }
    }
    
    // [MODIFIED] Using Firebase
    async function drawGraph(){
      const ctx=bioChart;
      if (myChart) {
        myChart.destroy();
      }
      
      const selectedMonth = document.getElementById('graphMonth').value;
      if (!selectedMonth) {
        alert("Please select a month to view the graph.");
        return;
      }
      
      const allData = [];
      try {
        const snapshot = await db.collection("harvestReport").get();
        snapshot.forEach(doc => {
          allData.push(doc.data());
        });
      } catch(e) {
        console.error("Error getting report data: ", e);
      }
      
      const filteredData = allData.filter(b => {
        if (!b.signDate) return false;
        try {
          const datePartStr = b.signDate.split('&')[1]?.trim();
          const [day, month, year] = datePartStr.split('/');
          const recordMonth = `${year}-${month.padStart(2, '0')}`;
          return recordMonth === selectedMonth;
        } catch (e) {
          return false;
        }
      });
      
      if(!filteredData.length) {
        ctx.getContext('2d').clearRect(0, 0, ctx.width, ctx.height);
        alert("No Bio Mass data available for this month!");
        return;
      }
      
      const selectEl = document.getElementById('graphMonth');
      const selectedMonthText = selectEl.options[selectEl.selectedIndex].text;
      document.getElementById('graphPrintTitle').textContent = `Bio Mass Trend - ${selectedMonthText}`;

      let savedMean = "16.06";
      try {
        const meanDoc = await db.collection("settings").doc("bioMassMean").get();
        if (meanDoc.exists) {
          savedMean = meanDoc.data().value;
        }
      } catch(e) { console.error("Error loading mean: ", e); }
      
      const lbl=filteredData.map(x=>x.suspension),
            cw=filteredData.map(x=>x.cakeWeight),
            m=Array(filteredData.length).fill(parseFloat(savedMean)), 
            low=Array(filteredData.length).fill(12),
            high=Array(filteredData.length).fill(18);
            
      myChart = new Chart(ctx,{type:"line",data:{labels:lbl,datasets:[{label:"Cake Weight",data:cw,borderColor:"blue",fill:false},{label:"Mean",data:m,borderColor:"green",borderDash:[5,5],fill:false},{label:"Lower",data:low,borderColor:"orange",borderDash:[4,4],fill:false},{label:"Higher",data:high,borderColor:"red",borderDash:[4,4],fill:false}]},
      options:{
        responsive:true,
        scales:{
          y:{
            beginAtZero:true,
            title: {
              display: true,
              text: 'Cake Weight',
              font: { size: 16 }
            }
          }
        }
      }});
    }
    
    function printGraph() {
      document.querySelectorAll('.print-area').forEach(el => el.classList.remove('print-area'));
      document.getElementById('mainHeader').classList.add('print-area');
      document.getElementById('graph').classList.add('print-area');
      window.print();
    }
    
    async function exportGraphPDF() {
      const { jsPDF } = window.jspdf;
      const graphSection = document.getElementById("graph");
      
      const header = document.getElementById('mainHeader');
      const graphTitle = document.getElementById('graphPrintTitle');
      const filterContainer = graphSection.querySelector('.filter-container');
      const buttonContainer = graphSection.querySelector('.button-container');

      // 1. Prepare for capture
      header.classList.add('print-area'); 
      graphTitle.classList.remove('hidden'); 
      filterContainer.classList.add('hidden'); 
      buttonContainer.classList.add('hidden'); 
      graphSection.classList.add('border-2', 'border-black', 'p-5'); 
      
      // 2. Capture canvas
      const canvas = await html2canvas(graphSection, { 
        onclone: (doc) => {
          const cloneTitle = doc.getElementById('graphPrintTitle');
          if (cloneTitle) {
            cloneTitle.style.display = 'block';
          }
        }
      });
      
      // 3. Clean up UI
      header.classList.remove('print-area');
      graphTitle.classList.add('hidden');
      filterContainer.classList.remove('hidden');
      buttonContainer.classList.remove('hidden');
      graphSection.classList.remove('border-2', 'border-black', 'p-5');
      
      // 4. Generate PDF
      const imgData = canvas.toDataURL('image/png');
      const pdf = new jsPDF('l', 'mm', 'a4'); // 'l' for landscape
      const pdfWidth = pdf.internal.pageSize.getWidth();
      const pdfHeight = (canvas.height * pdfWidth) / canvas.width;
      
      pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
      pdf.save("graph-report.pdf");
    }
    
    // --- [MODIFIED] MESSAGE FUNCTIONS ---
    
    // [MODIFIED] Using Firebase
    async function getReadMessages() {
      if (!currentUser) return {};
      try {
        const doc = await db.collection("readMessages").doc(currentUser.username).get();
        if (doc.exists) {
          return doc.data(); // e.g., { readIds: [...] }
        }
      } catch(e) { console.error("Error getting read messages:", e); }
      return { readIds: [] }; // Default
    }
    
    // [MODIFIED] Using Firebase
    async function updateMessageCount() {
      if (!currentUser) return;
      let allMessages = [];
      try {
        const snapshot = await db.collection("messages").get();
        snapshot.forEach(doc => {
          allMessages.push({ id: doc.id, ...doc.data() });
        });
      } catch(e) { console.error("Error getting messages:", e); }

      const { readIds } = await getReadMessages();
      
      let newMessagesCount = 0;
      allMessages.forEach(msg => {
        if (!readIds.includes(msg.id) && msg.sender !== currentUser.username) {
          newMessagesCount++;
        }
      });
      
      const badge = document.getElementById('messageCountBadge');
      if (newMessagesCount > 0) {
        badge.textContent = newMessagesCount;
        badge.classList.remove('hidden');
      } else {
        badge.classList.add('hidden');
      }
    }
    
    // [MODIFIED] Using Firebase
    async function markMessagesAsRead() {
      if (!currentUser) return;
      let allMessageIds = [];
      try {
        const snapshot = await db.collection("messages").get();
        snapshot.forEach(doc => {
          allMessageIds.push(doc.id);
        });
        
        await db.collection("readMessages").doc(currentUser.username).set({
          readIds: allMessageIds
        });
        
        updateMessageCount(); // Update the badge (which will now be 0)
      } catch(e) {
        console.error("Error marking messages as read:", e);
      }
    }

    // [NEW] Send System Message
    async function sendSystemMessage(text, senderName) {
      const newMessage = {
        id: Date.now(),
        sender: senderName,
        text: text,
        date: new Date().toLocaleString("en-GB"),
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      };
      
      try {
        await db.collection("messages").add(newMessage);
      } catch(e) {
        console.error("Error sending system message: ", e);
      }
    }

    // [MODIFIED] Using Firebase
    async function sendMessage() {
      const msgText = document.getElementById('messageText').value.trim();
      if (!msgText) return;
      
      const newMessage = {
        id: Date.now(),
        sender: currentUser.username,
        text: msgText,
        date: new Date().toLocaleString("en-GB"),
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      };
      
      try {
        const docRef = await db.collection("messages").add(newMessage);
        
        // Add this message to the sender's "read" list
        const { readIds } = await getReadMessages();
        readIds.push(docRef.id);
        await db.collection("readMessages").doc(currentUser.username).set({ readIds });

        document.getElementById('messageText').value = "";
        loadMessages();
      } catch(e) {
        console.error("Error sending message: ", e);
      }
    }
    
    // [MODIFIED] Using Firebase
    async function loadMessages() {
      const msgBox = document.getElementById('messageBox');
      msgBox.innerHTML = "";
      
      let messages = [];
      try {
        const snapshot = await db.collection("messages").orderBy("timestamp", "desc").get();
        snapshot.forEach(doc => {
          messages.push(doc.data());
        });
      } catch(e) {
        console.error("Error loading messages: ", e);
      }
      
      if (messages.length === 0) {
        msgBox.innerHTML = '<p class="text-gray-500 text-center">No messages yet.</p>';
        return;
      }
      
      messages.forEach(msg => {
        const msgEl = document.createElement('div');
        msgEl.className = "border-b border-gray-200 pb-3";
        msgEl.innerHTML = `
          <div class="flex justify-between items-center mb-1">
            <strong class="text-green-700">From: ${msg.sender}</strong>
            <span class="text-xs text-gray-500">${msg.date}</span>
          </div>
          <p class="text-gray-800 whitespace-pre-wrap">${msg.text}</p>
        `;
        msgBox.appendChild(msgEl);
      });
    }
    
    // --- [NEW] SETTINGS FUNCTIONS ---
    
    // [NEW] Log an audit event
    async function logAuditEvent(username, action) {
      try {
        await db.collection("auditLog").add({
          username: username,
          action: action,
          timestamp: firebase.firestore.FieldValue.serverTimestamp()
        });
      } catch (e) {
        console.error("Error logging audit event: ", e);
      }
    }
    
    // [NEW] Change password function
    async function changePassword() {
      const oldPass = document.getElementById('oldPassword').value;
      const newPass = document.getElementById('newPassword').value;
      const confirmPass = document.getElementById('confirmPassword').value;

      if (!oldPass || !newPass || !confirmPass) {
        return alert("‚ùå Please fill in all fields.");
      }
      
      if (newPass !== confirmPass) {
        return alert("‚ùå New passwords do not match.");
      }
      
      // Check old password
      if (currentUser.password !== oldPass) {
        return alert("‚ùå Your 'Old Password' is incorrect.");
      }
      
      // Prevent changing for the default admin
      if (currentUser.id === "defaultAdmin") {
        return alert("‚ùå You cannot change the password for the default 'admin' account.");
      }

      try {
        // Update password in Firebase
        await db.collection("users").doc(currentUser.id).update({
          password: newPass
        });
        
        // Update local currentUser object
        currentUser.password = newPass;
        
        // Log this action
        await logAuditEvent(currentUser.username, "Password Changed");
        
        // Send notifications
        await sendSystemMessage(`Your password was successfully changed.`, "System");
        await sendSystemMessage(`User '${currentUser.username}' has changed their password.`, "System (Admin)");
        
        alert("‚úÖ Password changed successfully!");
        document.getElementById('oldPassword').value = "";
        document.getElementById('newPassword').value = "";
        document.getElementById('confirmPassword').value = "";
        
      } catch (e) {
        console.error("Error changing password: ", e);
        alert("‚ùå An error occurred. Password not changed.");
      }
    }


    // [MODIFIED] Using Firebase - WITH ADD USER FIX
    async function addUser(){
      const n=newUsername.value.trim(),p=newPassword.value.trim(),r=newRole.value;
      if(!n||!p)return alert("Enter details");
      try {
        // Check if user already exists
        const snapshot = await db.collection("users").where("username", "==", n).get();
        if (!snapshot.empty) {
          return alert("‚ùå This username already exists!");
        }
        
        // Add the new user to the database
        await db.collection("users").add({ username: n, password: p, role: r });
        
        // [FIX] Reload the entire user table from the database
        await loadUsers(); 
        
        newUsername.value=newPassword.value="";
      } catch (e) {
        console.error("Error adding user: ", e);
      }
    }

    // [MODIFIED] Using Firebase
    async function loadUsers(){
      const t=userTable;t.innerHTML="";
      try {
        const snapshot = await db.collection("users").get();
        snapshot.forEach(doc => {
          const x = doc.data();
          const tr=document.createElement("tr");
          tr.className = "text-center"; 
          tr.innerHTML=`<td class="p-2 border-t">${x.username}</td>
                        <td class="p-2 border-t">${x.password}</td>
                        <td class="p-2 border-t">
                          <select onchange="updateUserRole('${doc.id}', this.value)" class="border rounded px-3 py-2">
                            <option ${x.role === 'Operator' ? 'selected' : ''}>Operator</option>
                            <option ${x.role === 'Supervisor' ? 'selected' : ''}>Supervisor</option>
                            <option ${x.role === 'SME' ? 'selected' : ''}>SME</option>
                            <option ${x.role === 'Manager' ? 'selected' : ''}>Manager</option>
                            <option ${x.role === 'Admin' ? 'selected' : ''}>Admin</option>
                          </select>
                        </td>
                        <td class="p-2 border-t"><button onclick="delUser('${doc.id}')" class='bg-red-500 text-white px-2 py-1 rounded'>üóëÔ∏è</button></td>`;
          t.appendChild(tr);
        });
      } catch(e) {
        console.error("Error loading users: ", e);
      }
    }
    
    // [NEW] Function to update a user's role in Firebase
    async function updateUserRole(docId, newRole) {
      try {
        await db.collection("users").doc(docId).update({
          role: newRole
        });
        alert("User role updated!");
        // If the admin changes their own role, update their permissions live
        if (currentUser && currentUser.id === docId) {
          currentUser.role = newRole;
          setupUIForRole();
        }
      } catch (e) {
        console.error("Error updating role: ", e);
        alert("Error updating role.");
      }
    }

    // [MODIFIED] Using Firebase
    async function delUser(docId){
      if (confirm("Are you sure you want to delete this user?")) {
        try {
          await db.collection("users").doc(docId).delete();
          await loadUsers(); // await to ensure list is fresh
        } catch(e) {
          console.error("Error deleting user: ", e);
        }
      }
    }
    
    // [MODIFIED] Using Firebase
    async function resetAllData() {
      const pass = document.getElementById('resetPasswordConfirm').value;
      if (!pass) {
        alert("Please enter your password to confirm.");
        return;
      }

      let passwordIsCorrect = false;
      if (currentUser.username === 'admin' && pass === '12345') {
        passwordIsCorrect = true;
      } else {
        // [FIX] Check password against current user in DB
        try {
          const userDoc = await db.collection("users").doc(currentUser.id).get();
          if (userDoc.exists && userDoc.data().password === pass) {
            passwordIsCorrect = true;
          }
        } catch (e) { console.error("Error verifying password:", e); }
      }

      if (!passwordIsCorrect) {
        alert("‚ùå Incorrect password!");
        return;
      }

      if (confirm("Are you sure you want to delete ALL REPORTS and MESSAGES? User accounts and permissions will NOT be deleted.")) {
        
        try {
          const batch = db.batch();
          
          // Delete all reports
          const reportSnapshot = await db.collection("harvestReport").get();
          reportSnapshot.forEach(doc => batch.delete(doc.ref));
          
          // Delete all messages
          const msgSnapshot = await db.collection("messages").get();
          msgSnapshot.forEach(doc => batch.delete(doc.ref));
          
          // Delete all read message receipts
          const readMsgSnapshot = await db.collection("readMessages").get();
          readMsgSnapshot.forEach(doc => batch.delete(doc.ref));
          
          // Delete all batch activity
          const batchActivitySnapshot = await db.collection("batchActivity").get();
          batchActivitySnapshot.forEach(doc => batch.delete(doc.ref));
          
          // [NEW] Delete all audit logs
          const auditLogSnapshot = await db.collection("auditLog").get();
          auditLogSnapshot.forEach(doc => batch.delete(doc.ref));

          // Delete other data
          batch.delete(db.collection("settings").doc("bioMassData"));
          batch.delete(db.collection("settings").doc("bioMassMean"));
          
          await batch.commit();

          alert("All reports and messages have been erased. Logging out.");
          logout();
          
        } catch (e) {
          console.error("Error resetting data: ", e);
          alert("An error occurred. Data was not reset.");
        }
      }
    }

  </script>
</body>
</html>